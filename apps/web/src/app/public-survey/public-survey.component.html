<!-- Loading State -->
@if (isLoading) {
<div class="loading-container">
  <mat-spinner diameter="48"></mat-spinner>
  <p>Loading survey...</p>
</div>
}

<!-- Error State -->
@if (error && !isLoading) {
<div class="error-container">
  <div class="error-content">
    <mat-icon>error_outline</mat-icon>
    <h2>{{ error }}</h2>
    <p>
      The survey you're looking for might have been removed or is no longer
      available.
    </p>
    <button mat-raised-button color="primary" (click)="goHome()">
      <mat-icon>home</mat-icon>
      Go to Homepage
    </button>
  </div>
</div>
}

<!-- Preview Banner -->
@if (isPreview && !isLoading && !error && !isSubmitted) {
<div class="preview-banner">
  <mat-icon>visibility</mat-icon>
  <span
    ><strong>Preview Mode</strong> — You're viewing a preview. Responses in
    preview mode are not saved.</span
  >
  <a [routerLink]="['/builder', survey?.id]" class="preview-cta"
    >Back to Builder</a
  >
</div>
}

<!-- Submitted State -->
@if (isSubmitted) {
<div class="submitted-container">
  <div class="submitted-content">
    <div class="success-icon">
      <mat-icon>check_circle</mat-icon>
    </div>
    <h2>Thank You!</h2>
    <p>Your response has been recorded successfully.</p>
    <button mat-stroked-button (click)="goHome()">
      <mat-icon>home</mat-icon>
      Back to Home
    </button>
  </div>
</div>
}

<!-- Survey Form -->
@if (!isLoading && !error && !isSubmitted) {
<div class="survey-wrapper">
  @if (!showSummary) {
  <div class="survey-container">
    <!-- Header -->
    <div class="survey-header">
      <h1>{{ formDef.name }}</h1>
      @if (formDef.description) {
      <p>{{ formDef.description }}</p>
      }
    </div>
    <!-- Progress -->
    <div class="progress-section">
      <div class="progress-info">
        <span class="progress-label">
          {{ formDef.pages[currentPage].name || "Page " + (currentPage + 1) }}
        </span>
        <span class="progress-count"
          >{{ currentPage + 1 }} of {{ formDef.pages.length }}</span
        >
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progressPercent"></div>
      </div>
    </div>
    <!-- Questions -->
    <div class="questions-section">
      <form [formGroup]="form">
        @for (el of formDef.pages[currentPage].elements; track el) {
        <div class="question-block">
          <app-question-host
            [question]="el.question"
            [form]="form"
          ></app-question-host>
        </div>
        }
      </form>
    </div>
    <!-- Navigation -->
    <div class="nav-section">
      @if (currentPage > 0) {
      <button mat-stroked-button (click)="prev()">
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>
      } @if (formDef.pages.length > 1) {
      <span class="page-indicator">
        Page {{ currentPage + 1 }} of {{ formDef.pages.length }}
      </span>
      } @if (currentPage < formDef.pages.length - 1) {
      <button mat-raised-button color="primary" (click)="next()">
        Next
        <mat-icon>arrow_forward</mat-icon>
      </button>
      } @if (currentPage === formDef.pages.length - 1 && formDef.pages.length >
      1) {
      <button mat-raised-button color="accent" (click)="next()">
        <mat-icon>checklist</mat-icon>
        Review & Submit
      </button>
      } @if (currentPage === formDef.pages.length - 1 && formDef.pages.length
      === 1) {
      <button mat-raised-button color="accent" (click)="submitSinglePage()">
        <mat-icon>send</mat-icon>
        Submit
      </button>
      }
    </div>
  </div>
  }
  <!-- Summary -->
  @if (showSummary) {
  <div class="survey-container">
    <div class="survey-header summary-header">
      <h1>Review Your Answers</h1>
      <p>Please confirm your responses before submitting.</p>
    </div>
    <div class="summary-section">
      <div class="summary-list">
        @for (page of formDef.pages; track page) { @if (page.name) {
        <div class="summary-page">
          <h3>{{ page.name }}</h3>
        </div>
        } @for (el of page.elements; track el) {
        <div class="summary-item">
          <div class="summary-question">{{ el.question.text }}</div>
          @if (!el.question.grid) {
          <div class="summary-answer">
            {{
              answerLabel(el.question.id, form.get(el.question.id)?.value) ||
                "—"
            }}
          </div>
          } @if (el.question.grid) {
          <div class="summary-answer grid-answer">
            @for (r of gridRowsFor(el.question.id); track r) {
            <div class="grid-row">
              <span class="row-label">{{ r.label }}:</span>
              <span class="row-value">{{
                gridRowValueLabel(el.question.id, r.id) || "—"
              }}</span>
            </div>
            }
          </div>
          }
        </div>
        } }
      </div>
    </div>
    <div class="nav-section">
      <button mat-stroked-button (click)="prev()">
        <mat-icon>edit</mat-icon>
        Edit Responses
      </button>
      <button mat-raised-button color="accent" (click)="submit()">
        <mat-icon>send</mat-icon>
        Submit Response
      </button>
    </div>
  </div>
  }
  <!-- Powered By Footer -->
  <div class="powered-by">
    <span>Powered by </span>
    <a routerLink="/">Angular Surveys</a>
  </div>
</div>
}
