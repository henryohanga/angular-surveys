<!-- Loading State -->
<div class="loading-container" *ngIf="isLoading">
  <mat-spinner diameter="48"></mat-spinner>
  <p>Loading survey...</p>
</div>

<!-- Error State -->
<div class="error-container" *ngIf="error && !isLoading">
  <div class="error-content">
    <mat-icon>error_outline</mat-icon>
    <h2>{{ error }}</h2>
    <p>
      The survey you're looking for might have been removed or is no longer
      available.
    </p>
    <button mat-raised-button color="primary" (click)="goHome()">
      <mat-icon>home</mat-icon>
      Go to Homepage
    </button>
  </div>
</div>

<!-- Preview Banner -->
<div
  class="preview-banner"
  *ngIf="isPreview && !isLoading && !error && !isSubmitted"
>
  <mat-icon>visibility</mat-icon>
  <span
    ><strong>Preview Mode</strong> — You're viewing a preview. Responses in
    preview mode are not saved.</span
  >
  <a [routerLink]="['/builder', survey?.id]" class="preview-cta"
    >Back to Builder</a
  >
</div>

<!-- Submitted State -->
<div class="submitted-container" *ngIf="isSubmitted">
  <div class="submitted-content">
    <div class="success-icon">
      <mat-icon>check_circle</mat-icon>
    </div>
    <h2>Thank You!</h2>
    <p>Your response has been recorded successfully.</p>
    <button mat-stroked-button (click)="goHome()">
      <mat-icon>home</mat-icon>
      Back to Home
    </button>
  </div>
</div>

<!-- Survey Form -->
<div class="survey-wrapper" *ngIf="!isLoading && !error && !isSubmitted">
  <div class="survey-container" *ngIf="!showSummary">
    <!-- Header -->
    <div class="survey-header">
      <h1>{{ formDef.name }}</h1>
      <p *ngIf="formDef.description">{{ formDef.description }}</p>
    </div>

    <!-- Progress -->
    <div class="progress-section">
      <div class="progress-info">
        <span class="progress-label">
          {{ formDef.pages[currentPage].name || "Page " + (currentPage + 1) }}
        </span>
        <span class="progress-count"
          >{{ currentPage + 1 }} of {{ formDef.pages.length }}</span
        >
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progressPercent"></div>
      </div>
    </div>

    <!-- Questions -->
    <div class="questions-section">
      <form [formGroup]="form">
        <div
          class="question-block"
          *ngFor="let el of formDef.pages[currentPage].elements"
        >
          <app-question-host
            [question]="el.question"
            [form]="form"
          ></app-question-host>
        </div>
      </form>
    </div>

    <!-- Navigation -->
    <div class="nav-section">
      <button
        mat-stroked-button
        (click)="prev()"
        [disabled]="currentPage === 0"
      >
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>

      <span class="page-indicator">
        Page {{ currentPage + 1 }} of {{ formDef.pages.length }}
      </span>

      <button
        mat-raised-button
        color="primary"
        (click)="next()"
        *ngIf="currentPage < formDef.pages.length - 1"
      >
        Next
        <mat-icon>arrow_forward</mat-icon>
      </button>

      <button
        mat-raised-button
        color="accent"
        (click)="showSummary = true"
        *ngIf="currentPage === formDef.pages.length - 1"
      >
        <mat-icon>checklist</mat-icon>
        Review & Submit
      </button>
    </div>
  </div>

  <!-- Summary -->
  <div class="survey-container" *ngIf="showSummary">
    <div class="survey-header summary-header">
      <h1>Review Your Answers</h1>
      <p>Please confirm your responses before submitting.</p>
    </div>

    <div class="summary-section">
      <div class="summary-list">
        <ng-container *ngFor="let page of formDef.pages">
          <div class="summary-page" *ngIf="page.name">
            <h3>{{ page.name }}</h3>
          </div>
          <div class="summary-item" *ngFor="let el of page.elements">
            <div class="summary-question">{{ el.question.text }}</div>
            <div class="summary-answer" *ngIf="!el.question.grid">
              {{
                answerLabel(el.question.id, form.get(el.question.id)?.value) ||
                  "—"
              }}
            </div>
            <div class="summary-answer grid-answer" *ngIf="el.question.grid">
              <div
                *ngFor="let r of gridRowsFor(el.question.id)"
                class="grid-row"
              >
                <span class="row-label">{{ r.label }}:</span>
                <span class="row-value">{{
                  gridRowValueLabel(el.question.id, r.id) || "—"
                }}</span>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <div class="nav-section">
      <button mat-stroked-button (click)="prev()">
        <mat-icon>edit</mat-icon>
        Edit Responses
      </button>
      <button mat-raised-button color="accent" (click)="submit()">
        <mat-icon>send</mat-icon>
        Submit Response
      </button>
    </div>
  </div>

  <!-- Powered By Footer -->
  <div class="powered-by">
    <span>Powered by</span>
    <a routerLink="/">Angular Surveys</a>
  </div>
</div>
